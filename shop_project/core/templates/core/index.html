<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û—Ç–∑—ã–≤—ã - TECH SHOP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .navbar { background: linear-gradient(90deg, #2c3e50, #000000); }
        .review-card { border: none; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #0d6efd; }
        .form-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">üöÄ TECH SHOP</a>
        <a href="/" class="btn btn-outline-light btn-sm">–ö —Ç–æ–≤–∞—Ä–∞–º</a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-5 mb-4">
            <div class="form-section">
                <h4 class="mb-3">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h4>
                <div class="mb-3">
                    <label class="form-label">–í–∞—à–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ</label>
                    <textarea id="rev-text" class="form-control" rows="3" placeholder="–ß—Ç–æ –≤—ã –¥—É–º–∞–µ—Ç–µ –æ –º–∞–≥–∞–∑–∏–Ω–µ?"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">–û—Ü–µ–Ω–∫–∞ (1-5)</label>
                    <input type="number" id="rev-rating" class="form-control" min="1" max="5" value="5">
                </div>
                <button onclick="submitReview()" class="btn btn-primary w-100 fw-bold">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <div id="status-msg" class="mt-2"></div>
            </div>
        </div>

        <div class="col-md-7">
            <h4 class="mb-3">–í—Å–µ –æ—Ç–∑—ã–≤—ã</h4>
            <div id="reviews-list">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. –ó–ê–ì–†–£–ó–ö–ê –û–¢–ó–´–í–û–í
    async function loadReviews() {
        const list = document.getElementById('reviews-list');
        try {
            // –ü—É—Ç—å –∫ —Ç–≤–æ–µ–º—É –Ω–æ–≤–æ–º—É API
            const response = await fetch('/api/reviews/list/');
            const reviews = await response.json();

            list.innerHTML = '';
            if (reviews.length === 0) {
                list.innerHTML = '<div class="alert alert-light text-center">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            reviews.reverse().forEach(r => { // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∑—ã–≤—ã —Å–≤–µ—Ä—Ö—É
                list.innerHTML += `
                    <div class="card review-card shadow-sm">
                        <div class="card-body">
                            <h5 class="text-warning">‚≠ê ${r.rating}/5</h5>
                            <p class="mb-0">${r.text}</p>
                            <small class="text-muted">ID –æ—Ç–∑—ã–≤–∞: ${r.id}</small>
                        </div>
                    </div>`;
            });
        } catch (e) {
            list.innerHTML = '<div class="alert alert-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã</div>';
        }
    }

    // 2. –û–¢–ü–†–ê–í–ö–ê –û–¢–ó–´–í–ê
    async function submitReview() {
        const text = document.getElementById('rev-text').value;
        const rating = document.getElementById('rev-rating').value;
        const status = document.getElementById('status-msg');

        if (!text) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞");
            return;
        }

        try {
            const response = await fetch('/api/reviews/list/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // –î–æ–±–∞–≤—å —ç—Ç–æ, –µ—Å–ª–∏ Django –±—É–¥–µ—Ç —Ä—É–≥–∞—Ç—å—Å—è –Ω–∞ CSRF:
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ text, rating })
            });

            if (response.ok) {
                status.innerHTML = '<div class="text-success small">‚úÖ –û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</div>';
                document.getElementById('rev-text').value = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                loadReviews(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
            } else {
                throw new Error();
            }
        } catch (e) {
            status.innerHTML = '<div class="text-danger small">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ (–Ω—É–∂–Ω–∞ –¥–ª—è Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    loadReviews(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
</script>

</body>
</html>